<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
    <title>Phaser - Making your first game, part 9</title>
    <script src="//cdn.jsdelivr.net/phaser/2.2.2/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, 'arvutused', { preload: preload, create: create, update: update });

function preload() {

    game.load.image('sky', 'assets/sky.png');
    game.load.image('kast', 'assets/sinine_kast.png');
    game.load.image('asukoht', 'assets/koht.png');
    game.load.image('ground', 'assets/platform.png');
    game.load.image('star', 'assets/star.png');
    game.load.spritesheet('dude', 'assets/dude.png', 32, 48);
    
}

function Gate(value, x, y) {
    this.value = value;
    this.x = x;
    this.y = y;
    this.operatorOffset = 48;
    this.operatorWidth = 16;
    this.targetStep = this.operatorOffset + this.operatorWidth;
    this.targetYOffset = 14;
    this.operatorYOffset = 22;
    this.valueYOffset = 0;
    this.confettiDelay = 350;
    this.targets = new Array();
    this.inputCount = 0;
    this.notes = new Array();
}

Gate.prototype.init = function(inputCount) {
    this.inputCount = inputCount;
    var valueText = game.add.text(this.x + (inputCount * this.targetStep - this.operatorWidth) / 2, this.y + this.valueYOffset, '' + this.value + ' =', { fontSize: '32px', fill: '#000' });
    valueText.anchor.set(0.5);
    this.notes.push(valueText);
    notes.addChild(valueText);
    for (var i = 0 ; i < inputCount ; i++) {
        var target = createTarget(this.x + i * this.targetStep, this.y + this.targetYOffset);
        if (i < inputCount - 1) {
            // Add a + sign
            var operator = game.add.text(this.x + i * this.targetStep + this.operatorOffset, this.y + this.operatorYOffset, '+', { fontSize: '32px', fill: '#000' });
            this.notes.push(operator);
            notes.addChild(operator);
        }
        var thisGate = this;
        target.onUpdate = function(res) {
            var sum = 0;
            thisGate.targets.forEach(function(t) {
                if (t.filled) {
                    sum += t.res.customValue;
                }
            });
            console.log("g@" + thisGate.x + ", s=" + sum);
            if (sum == thisGate.value) {
                // disable modification
                thisGate.lock();
                // start to progress
                progressing++;
                // throw confetti
                confetti(thisGate);
                timer.repeat(thisGate.confettiDelay, thisGate.value - 1, confetti, this, thisGate);
                var lockdownTime = thisGate.confettiDelay * (thisGate.value - 1);
                // destroy afterwards
                timer.add(lockdownTime, function() {
                    progressing--;
                    thisGate.destroy();
                }, thisGate);
            }
        };
        this.targets.push(target);
    }
}

Gate.prototype.lock = function() {
    // Lock targets and ress.
    this.targets.forEach(function(t) {
        t.lock();
        if (t.filled && t.res) {
            t.res.input.draggable = false;
        }
    });
    console.log("g@" + this.x + " locked");
}

Gate.prototype.destroy = function() {
    // destroy targets and ress
    this.targets.forEach(function(t) {
        if (t.filled && t.res) {
            t.res.destroy();
        }
        t.destroy();
    });
    // destroy text components
    this.notes.forEach(function(n) {
        n.destroy();
    });
    // increment score
    score += 10;
    scoreText.text = 'Score: ' + score;
    // create new Gate
    new Gate(Math.floor(Math.random() * 6) + 5, this.x, this.y).init((Math.random() > 0.5 ? 2 : 3));
}

var player;
var platforms;
var cursors;

var targets;
var notes;
var dispensers;

var stars;
var score = 0;
var scoreText;

var timer;
var emitter;

var progressing = 0;

function create() {
    timer = game.time.create(false);
    timer.start();
    
    //  We're going to be using physics, so enable the Arcade Physics system
    game.physics.startSystem(Phaser.Physics.ARCADE);

    //  A simple background for our game
    game.add.sprite(0, 0, 'sky');

    //  The platforms group contains the ground and the 2 ledges we can jump on
    platforms = game.add.group();
    
    //  We will enable physics for any object that is created in this group
    platforms.enableBody = true;

    // Here we create the ground.
    var ground = platforms.create(0, game.world.height - 64, 'ground');

    //  Scale it to fit the width of the game (the original sprite is 400x32 in size)
    ground.scale.setTo(2, 2);

    //  This stops it from falling away when you jump on it
    ground.body.immovable = true;

    //  Now let's create two ledges
    var ledge = platforms.create(400, 400, 'ground');
    ledge.body.immovable = true;

    ledge = platforms.create(-150, 250, 'ground');
    ledge.body.immovable = true;
    
    notes = game.add.group();

    // targets
    targets = game.add.group();
    targets.enableBody =  true;
    
    new Gate(10, 50, 170).init(2);
    
    new Gate(10, 250, 170).init(3);
    
    new Gate(10, 450, 170).init(3);
//     createTarget(50, 50);
//     createTarget(100, 50);

    dispensers = new Array();
    createDispenser(75, 400);
    createDispenser(150, 400);
    createDispenser(225, 400);

    // The player and its settings
    player = game.add.sprite(32, game.world.height - 150, 'dude');

    //  We need to enable physics on the player
    game.physics.arcade.enable(player);

    //  Player physics properties. Give the little guy a slight bounce.
    player.body.bounce.y = 0.2;
    player.body.gravity.y = 300;
    player.body.collideWorldBounds = true;

    //  Our two animations, walking left and right.
    player.animations.add('left', [0, 1, 2, 3], 10, true);
    player.animations.add('right', [5, 6, 7, 8], 10, true);
    
    //  Finally some stars to collect
    stars = game.add.group();
    stars.enableBody = true;

    //  The score
    scoreText = game.add.text(16, 16, 'score: 0', { fontSize: '32px', fill: '#000' });

    //  Our controls.
    cursors = game.input.keyboard.createCursorKeys();
    
    emitter = game.add.emitter(0, 0, 100);
    emitter.makeParticles('star');
    emitter.gravity = 150;
}

function update() {

    //  Collide the player and the stars with the platforms
    game.physics.arcade.collide(player, platforms);
    game.physics.arcade.collide(stars, platforms);
    
    //  Checks to see if the player overlaps with any of the stars, if he does call the collectStar function
    game.physics.arcade.overlap(player, stars, collectStar, null, this);

    //  Reset the players velocity (movement)
    player.body.velocity.x = 0;

    if (cursors.left.isDown)
    {
        //  Move to the left
        player.body.velocity.x = -150;

        player.animations.play('left');
    }
    else if (cursors.right.isDown || progressing > 0)
    {
        //  Move to the right
        player.body.velocity.x = 150;

        player.animations.play('right');
    }
    else
    {
        //  Stand still
        player.animations.stop();

        player.frame = 4;
    }
    
    //  Allow the player to jump if they are touching the ground.
    if (cursors.up.isDown && player.body.touching.down)
    {
        player.body.velocity.y = -350;
    }
    
    // Dispense new res, if needed.
    dispensers.forEach(function(dispenser) {
        if (dispenser.target.filled) {
            return;
        }
        var res = createRes();
        dispenser.target.putRes(res);
    });

}

function confetti(gate) {
    var width = (gate.inputCount * gate.targetStep - gate.operatorWidth);
    emitter.x = gate.x + 0.25 * width + Math.random() * width * (0.25 + 0.25);
    emitter.y = gate.y + Math.random() * 30;
    emitter.start(true, 2400, null, 1);
    console.log("g@" + gate.x + "x" + gate.y);
}

function createRes() {
    var star = stars.create(90, game.world.height - 150, 'kast');
    
    star.inputEnabled = true;
    star.input.enableDrag(false, true);
    star.input.useHandCursor = true;
    star.events.onDragStart.add(function(){
        star.dragStart = {
            x: star.x,
            y: star.y
        };
    }, this);
    star.events.onDragStop.add(function(){
        var overlapped = Array();
        game.physics.arcade.overlap(star, targets, function(star, target) {
            overlapped.push(target);
        }, function(star, target) {
            if (target.locked || (target.filled && star.atTarget != target)) {
                return false;
            }
        }, this);

        // find closest
        var c_d2 = 99999;
        var closest = null;
        overlapped.forEach(function(target){
            var d2 = (target.x - star.x)*(target.x - star.x) + (target.y - star.y)*(target.y - star.y);
            if (d2 < c_d2) {
                c_d2 = d2;
                closest = target;
            }
        });
        
        if (closest == null) {
            // return to previous position
            star.x = star.dragStart.x;
            star.y = star.dragStart.y;
        } else {
            // snap and put to closest target
            closest.putRes(star);
        }
    }, this);
    
    star.customValue = Math.floor(Math.random() * 9) + 1;
    star.customText = game.add.text(28, 26, star.customValue, { font: "24px Arial", fill: "#112200", wordWrap: true, wordWrapWidth: star.width, align: "center" });
    star.customText.anchor.set(0.5);
    star.addChild(star.customText);
    
    return star;
}

function createTarget(x, y) {
    var target = targets.create(x, y, 'asukoht');
    target.body.immovable = true;
    target.onUpdate = function(res){};
    target.res = null;
    target.locked = false;
    target.lock = function() {
        target.locked = true;
    }
    target.putRes = function(res) {
        res.x = target.x;
        res.y = target.y;
        // set old target empty, if it existed
        var oldTarget = null;
        if (res.atTarget) {
            oldTarget = res.atTarget;
            oldTarget.filled = false;
            oldTarget.res = null;
        }
        // connect to new target
        res.atTarget = target;
        // mark it as filled
        target.filled = true;
        target.res = res;
        target.onUpdate(res);
        if (oldTarget != null) {
            oldTarget.onUpdate(null);
        }
    };
    return target;
}

function createDispenser(x, y) {
    var target = createTarget(x, y);
    dispensers.push({
        target: target
    });
}

function collectStar (player, star) {
    
    // Removes the star from the screen
    star.customText.destroy();
    star.destroy();
    
    if (star.atTarget) {
        star.atTarget.filled = false;
        star.atTarget.res = null;
        star.atTarget.onUpdate(null);
    }

    //  Add and update the score
    score += 10;
    scoreText.text = 'Score: ' + score;

}

</script>

</body>
</html>